name: ðŸ§ª CI Proof Core Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      ANCHOR_VERSION: 0.31.1
      SOLANA_VERSION: 1.18.11
      NODE_VERSION: 20.18.0

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸ§° Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: ðŸ’¾ Cache Cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: ðŸ’¾ Cache Cargo git repos
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: âš“ Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.anza.xyz/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: ðŸš€ Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v${ANCHOR_VERSION} anchor-cli --locked

      - name: ðŸŸ¢ Install Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install Node dependencies
        run: yarn install

      - name: ðŸ”§ Start Solana test validator
        run: |
          nohup solana-test-validator > validator.log 2>&1 &
          sleep 10
          solana config set --url http://localhost:8899

      - name: ðŸ” Create default Solana keypair
        run: |
          mkdir -p ~/.config/solana
          solana-keygen new --no-bip39-passphrase -o ~/.config/solana/id.json --force
          solana config set --keypair ~/.config/solana/id.json
          solana airdrop 2

      - name: ðŸ§± Build Anchor program
        run: anchor build

      - name: ðŸ“¡ Deploy Anchor program
        run: anchor deploy

      - name: â³ Wait for program readiness
        run: >
          node --import 'data:text/javascript,import { register } from "node:module";
          import { pathToFileURL } from "node:url";
          register("ts-node/esm", pathToFileURL("./"))'
          --no-warnings scripts/wait-for-program.ts

      - name: ðŸ§ª Run Mocha test suite
        run: yarn test
